<?xml version="1.0" encoding="utf-8"?>
<!--
    # This comment is generated by WixEdit, the specific commandline
    # arguments for the WiX Toolset are stored here.

    candleArgs: "<projectfile>" -out "<projectname>.wixobj" <extensions> -dVersion=1.0.0.0 -dProjectDir=.\..\..\bin\release
    lightArgs: "<projectname>.wixobj" -out "<projectname>.msi" <extensions> -cultures:ru-ru
-->
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
    <Product Id="*" Language="1033" Manufacturer="Trustbox" Name="Rabnet $(var.Version)" Version="$(var.Version)" UpgradeCode="8F4BB748-14F8-47B7-8F35-C567F0A1B29A">
        <Package Description="Rabnet $(var.Version)" InstallerVersion="310" Compressed="yes" />
        <Upgrade Id="8F4BB748-14F8-47B7-8F35-C567F0A1B29A">
            <UpgradeVersion Minimum="$(var.Version)" IncludeMinimum="no" OnlyDetect="yes" Property="NEWERVERSIONDETECTED" />
            <UpgradeVersion Minimum="0.0.0" IncludeMinimum="yes" Maximum="$(var.Version)" IncludeMaximum="no" Property="OLDERVERSIONBEINGUPGRADED" />
        </Upgrade>
        <PropertyRef Id="NETFRAMEWORK20" />
        <Property Id="FARMHERE" Value="yes" />
		<Property Id='HASMYSQL'> 
			<RegistrySearch Id='mysql' Root='HKCU' Key='SOFTWARE\TestInstall' Name='hasMysql' Type='raw' /> 
		</Property> 
		<Property Id="CMDEXE">cmd.exe</Property>
        <Condition Message="Установлена более новая версия продукта"><![CDATA[NOT NEWERVERSIONDETECTED]]></Condition>
        <CustomAction Id="PropertyAssign" Property="NETINSTALLER" Value="[CURRENTDIRECTORY]\$(var.NetInstaller)" />
        <CustomAction Id="SetupNETFX" Property="NETINSTALLER" ExeCommand="" />
        <CustomAction Id="Property2Assign" Property="MYSQLINSTALLER" Value="[CURRENTDIRECTORY]\$(var.MysqlInstaller)" />
        <CustomAction Id="SetupMysql" Property="MYSQLINSTALLER" ExeCommand="" />
        <CustomAction Id="Property3Assign" Property="RABNETUPDATER" Value="[RabbitsDir]updater.exe" />
        <CustomAction Id="RabnetUpdate" Property="RABNETUPDATER" ExeCommand="" />
        <CustomAction Id="DeleteUpdater" Property="CMDEXE" ExeCommand="/C del &quot;[RABNETUPDATER]&quot;" />
        <InstallExecuteSequence>
            <RemoveExistingProducts After="InstallInitialize" />
            <Custom Action="PropertyAssign" After="RemoveExistingProducts" />
            <Custom Action="Property2Assign" After="PropertyAssign" />
            <Custom Action="Property3Assign" After="Property2Assign" />
            <Custom Action="SetupNETFX" After="Property3Assign">NOT Installed AND NOT NETFRAMEWORK20</Custom>
            <Custom Action="SetupMysql" After="Property3Assign">NOT Installed AND (FARMHERE="yes") AND (NOT HASMYSQL="1")</Custom>
			<Custom Action="RabnetUpdate" After="InstallFinalize">NOT Installed</Custom>
			<Custom Action="DeleteUpdater" After="RabnetUpdate">NOT Installed</Custom>
        </InstallExecuteSequence>
        <!--Condition Message="Для работы программы необходим .NET Framework 2.0. Установите .NET Framework, а потом перезапустите утановку данного продукта">
			<![CDATA[Installed OR NETFRAMEWORK20]]>
		</Condition-->
        <Media Id="1" Cabinet="rabnet.cab" EmbedCab="yes" />
        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="ProgramFilesFolder" Name="PFiles">
                <Directory Id="RabbitsDir" Name="RabNet">
                    <Component Id="MainProgram" Guid="3D19CA32-71E7-4A06-B323-142F4C03DB42">
                        <File Id="rabnet.exe" Source="$(var.ProjectDir)\rabnet.exe" Checksum="yes" KeyPath="yes" />
                        <File Id="mia_conv.exe" Source="$(var.ProjectDir)\mia_conv.exe" Checksum="yes" />
                        <File Id="db.mysql.dll" Source="$(var.ProjectDir)\db.mysql.dll" Checksum="yes" />
                        <File Id="engine.dll" Source="$(var.ProjectDir)\engine.dll" Checksum="yes" />
                        <File Id="log4net.dll" Source="$(var.ProjectDir)\log4net.dll" Checksum="yes" />
                        <File Id="Mysql.Data.dll" Source="$(var.ProjectDir)\Mysql.Data.dll" Checksum="yes" />
                        <File Id="RdlEngine.dll" Source="$(var.ProjectDir)\RdlEngine.dll" Checksum="yes" />
                        <File Id="RdlViewer.dll" Source="$(var.ProjectDir)\RdlViewer.dll" Checksum="yes" />
                        <File Id="updater.exe" Source="$(var.ProjectDir)\..\tools\updater.exe" Checksum="yes" />
                    </Component>
                    <Directory Id="ReportsDir" Name="reports">
                        <Component Id="Reports" Guid="AF1369D3-6231-4FE8-8884-7ECDA59DE059">
                            <File Id="age.rdl" Source="$(var.ProjectDir)\reports\age.rdl" Checksum="yes" />
                            <File Id="breeds.rdl" Source="$(var.ProjectDir)\reports\breeds.rdl" Checksum="yes" />
                            <File Id="dead.rdl" Source="$(var.ProjectDir)\reports\dead.rdl" Checksum="yes" />
                            <File Id="deadreason.rdl" Source="$(var.ProjectDir)\reports\deadreason.rdl" Checksum="yes" />
                            <File Id="fucker.rdl" Source="$(var.ProjectDir)\reports\fucker.rdl" Checksum="yes" />
                            <File Id="rabbit.rdl" Source="$(var.ProjectDir)\reports\rabbit.rdl" Checksum="yes" KeyPath="yes" />
                            <File Id="realization.rdl" Source="$(var.ProjectDir)\reports\realization.rdl" Checksum="yes" />
                            <File Id="zooteh.rdl" Source="$(var.ProjectDir)\reports\zooteh.rdl" Checksum="yes" />
                            <File Id="zooteh_nofuck.rdl" Source="$(var.ProjectDir)\reports\zooteh_nofuck.rdl" Checksum="yes" />
                        </Component>
                    </Directory>
                </Directory>
            </Directory>
            <Directory Id="ProgramMenuFolder" Name="ProgramsMenu">
                <Directory Id="MenuDir" Name="Миакро">
                    <Component Id="MenuShortcuts" Guid="507B20FA-2868-4241-94D3-D8EDE75EAC9F">
                        <Shortcut Id="UninstallShortcut" Name="Удалить" Target="[System64Folder]msiexec.exe" Arguments="/x [ProductCode]" />
                        <Shortcut Id="miaconvShortcut" Name="Импорт фермы" WorkingDirectory="RabbitsDir" Target="[RabbitsDir]mia_conv.exe" />
                        <Shortcut Id="rabnetShortcut" Name="Миакро rabnet" WorkingDirectory="RabbitsDir" Target="[RabbitsDir]rabnet.exe" />
                        <RemoveFolder Id="MenuDir" On="uninstall" />
                        <RegistryValue Root="HKCU" Key="Software\TrustBox\RabNet" Name="installed" Type="integer" Value="1" KeyPath="yes" />
                    </Component>
                </Directory>
            </Directory>
            <Directory Id="DesktopFolder">
                <Component Id="DesktopShortcuts" Guid="D7CA67CD-9F2B-43D6-B98A-C907BD09CE3D">
                    <Shortcut Id="rabnetDesktopShortcut" Name="Миакро rabnet" WorkingDirectory="RabbitsDir" Target="[RabbitsDir]rabnet.exe" />
                    <RegistryValue Root="HKCU" Key="Software\TrustBox\RabNet" Name="desktop" Type="integer" Value="1" KeyPath="yes" />
                </Component>
            </Directory>
        </Directory>
        <Feature Id="FullSetup" Level="1" Title="FullInstall">
            <ComponentRef Id="MainProgram" />
            <ComponentRef Id="Reports" />
            <ComponentRef Id="MenuShortcuts" />
            <ComponentRef Id="DesktopShortcuts" />
        </Feature>
        <UIRef Id="WixUI_Minimal" />
        <UI>
			<TextStyle Id="DlgFontBold8" FaceName="Tahoma" Size="8" Bold="yes" />
            <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="SelectFarmType">1</Publish>
            <Dialog Id="SelectFarmType" Width="370" Height="270" Title="Установка rabnet">
                <Control Type="PushButton" Id="next" Width="56" Height="17" X="236" Y="243" Text="Далее">
                    <Publish Event="SpawnDialog" Value="ProgressDlg">
                    </Publish>
                </Control>
                <Control Type="PushButton" Id="cancel" Width="56" Height="17" X="304" Y="243" Text="Отмена">
                    <Publish Event="SpawnDialog" Value="CancelDlg" />
                </Control>
                <Control Type="PushButton" Id="back" Width="56" Height="17" X="180" Y="243" Text="Назад">
                    <Publish Event="NewDialog" Value="WelcomeDlg" />
                </Control>
                <Control Type="Line" Id="bl" Width="370" Height="2" X="0" Y="234" />
                <Control Type="Bitmap" Id="btop" Width="370" Height="44" X="0" Y="0" Text="!(loc.LicenseAgreementDlgBannerBitmap)" />
                <Control Type="Text" Id="t1" Width="154" Height="17" X="101" Y="71" Text="Выберите место расположения фермы" Transparent="yes" />
                <Control Type="RadioButtonGroup" Property="FARMHERE" Id="rg1" Width="230" Height="42" X="94" Y="146">
                    <RadioButtonGroup Property="FARMHERE">
                        <RadioButton Text="Ферма расположена на этом компьютере (необходимо наличие mysqld)" Height="22" Value="yes" Width="200" X="0" Y="0" />
                        <RadioButton Text="Ферма расположена на другом компьютере в сети" Height="17" Value="no" Width="250" X="0" Y="25" />
                    </RadioButtonGroup>
                </Control>
                <Control Type="Line" Id="tl" Width="370" Height="2" X="0" Y="44" />
                <Control Type="Text" Id="title" Width="214" Height="15" X="34" Y="15" Transparent="yes">
                    <Text>{&amp;DlgFontBold8}Установка rabnet</Text>
                </Control>
            </Dialog>
        </UI>
    </Product>
</Wix>